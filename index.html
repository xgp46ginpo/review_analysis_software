<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è¯„è®ºåˆ†æç³»ç»Ÿ</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40NzcgMiAyIDYuNDc3IDIgMTJDMiAxNy41MjMgNi40NzcgMjIgMTIgMjJDMTcuNTIzIDIyIDIyIDE3LjUyMyAyMiAxMkMyMiA2LjQ3NyAxNy41MjMgMiAxMiAyWk0xMiA0QzE2LjQxOCA0IDIwIDcuNTgyIDIwIDEyQzIwIDE2LjQxOCAxNi40MTggMjAgMTIgMjBDNy41ODIgMjAgNCAxNi40MTggNCAxMkM0IDcuNTgyIDcuNTgyIDQgMTIgNFpNMTIgN0ExIDEgMCAwIDEgMTMgOEwxMyAxM0ExIDEgMCAwIDEgMTIgMTRBMSAxIDAgMCAxIDExIDEzTExgOEExIDEgMCAwIDEgMTIgN1oiIGZpbGw9ImN1cnJlbnRDb2xvciIvPgo8L3N2Zz4=" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css">
    <style>
.file-upload {
    margin-bottom: 20px;
    text-align: center;
}

.file-upload input[type="file"] {
    display: none;
}

.upload-btn {
    background-color: #28a745;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 1em;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.upload-btn:hover {
    background-color: #218838;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.upload-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.hidden {
    display: none !important;
}

#initial-state {
    text-align: center;
    padding: 60px 20px;
    border: 2px dashed #ced4da;
    border-radius: 12px;
    margin-top: 40px;
    color: #6c757d;
}

#initial-state h2 {
    color: #343a40;
}

body {
    font-family: 'Pretendard Variable', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0; /* ç§»é™¤ body é»˜è®¤ paddingï¼Œè®© container æ§åˆ¶ */
    background-color: #f0f2f5; /* æ›´æŸ”å’Œçš„èƒŒæ™¯è‰² */
    color: #343a40; /* æ·±ç°è‰²æ–‡æœ¬ */
    line-height: 1.6;
    display: flex; /* ä½¿ç”¨ flex å¸ƒå±€å±…ä¸­å†…å®¹ */
    justify-content: center;
    align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
    min-height: 100vh; /* æœ€å°é«˜åº¦ä¸ºè§†å£é«˜åº¦ */
    padding: 20px; /* æ•´ä½“ padding */
    box-sizing: border-box; /* ç›’æ¨¡å‹ */
}

.container {
    width: 100%; /* å®½åº¦è‡ªé€‚åº” */
    max-width: 1400px; /* ä¿æŒæœ€å¤§å®½åº¦ */
    margin: 0 auto; /* è‡ªåŠ¨å±…ä¸­ */
    background-color: #ffffff;
    padding: 30px 40px; /* å¢åŠ å·¦å³å†…è¾¹è· */
    border-radius: 16px; /* æ›´å¤§çš„åœ†è§’ */
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); /* æ›´æ˜æ˜¾çš„é˜´å½± */
    box-sizing: border-box;
}

h1 {
    text-align: center;
    color: #1a202c; /* æ›´æ·±çš„æ ‡é¢˜é¢œè‰² */
    margin-bottom: 35px; /* å¢åŠ åº•éƒ¨é—´è· */
    font-size: 2.5em; /* å¢å¤§æ ‡é¢˜å­—å· */
    font-weight: 700; /* æ›´ç²—çš„å­—ä½“ */
    letter-spacing: -0.03em; /* è°ƒæ•´å­—é—´è· */
    background: linear-gradient(90deg, #007bff, #0056b3); /* æ¸å˜èƒŒæ™¯ */
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.filters {
    position: sticky; /* è®¾ç½®ä¸ºç²˜æ€§å®šä½ */
    top: 0; /* æ»šåŠ¨åˆ°é¡¶éƒ¨æ—¶å›ºå®š */
    z-index: 999; /* ç¡®ä¿å®ƒåœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Š */
    background-color: #ffffff; /* æ·»åŠ èƒŒæ™¯è‰²ä»¥é˜²ä¸‹æ–¹å†…å®¹é€å‡º */
    margin-bottom: 40px;
    display: flex;
    flex-wrap: wrap;
    gap: 25px; /* å¢åŠ é—´è· */
    align-items: center;
    justify-content: center;
    padding: 20px 25px; /* å¢åŠ å†…è¾¹è· */
    background: #fdfdfd; /* æ›´äº®çš„èƒŒæ™¯ */
    border-radius: 12px; /* æ›´å¤§çš„åœ†è§’ */
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* æ›´æ˜æ˜¾çš„é˜´å½± */
    border: 1px solid #e0e0e0; /* ç»†è¾¹æ¡† */
}

.filter-group {
    display: flex;
    flex-direction: column; /* æ ‡ç­¾å’Œè¾“å…¥æ¡†å‚ç›´æ’åˆ— */
    align-items: flex-start; /* å·¦å¯¹é½ */
    gap: 8px; /* æ ‡ç­¾å’Œè¾“å…¥æ¡†ä¹‹é—´çš„é—´è· */
    background: none; /* ç§»é™¤èƒŒæ™¯ */
    padding: 0; /* ç§»é™¤å†…è¾¹è· */
    border-radius: 0; /* ç§»é™¤åœ†è§’ */
    border: none; /* ç§»é™¤è¾¹æ¡† */
}

.filter-group label {
    font-weight: 600; /* æ›´ç²—çš„å­—ä½“ */
    color: #495057;
    white-space: nowrap;
    font-size: 0.95em; /* ç¨å¾®å¢å¤§å­—å· */
    margin-bottom: 2px; /* æ ‡ç­¾å’Œè¾“å…¥æ¡†ä¹‹é—´çš„é¢å¤–é—´è· */
}

.date-picker, #productId {
    padding: 10px 15px; /* å¢åŠ å†…è¾¹è· */
    border: 1px solid #ced4da;
    border-radius: 8px; /* æ›´å¤§çš„åœ†è§’ */
    font-size: 15px; /* å¢å¤§å­—å· */
    min-width: 250px; /* å¢åŠ æœ€å°å®½åº¦ */
    transition: border-color 0.2s, box-shadow 0.2s;
    background-color: #f8f9fa; /* æµ…ç°è‰²èƒŒæ™¯ */
    color: #343a40;
}

.date-picker:focus, #productId:focus {
    outline: none;
    border-color: #007bff; /* è“è‰²è¾¹æ¡† */
    box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25); /* è“è‰²é˜´å½± */
    background-color: #ffffff; /* èšç„¦æ—¶ç™½è‰²èƒŒæ™¯ */
}

.quick-date-filters {
    display: flex;
    gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„é—´è· */
    margin-top: 10px; /* ä¸æ—¥æœŸé€‰æ‹©å™¨ä¸Šæ–¹çš„é—´è· */
}

.quick-date-filters button {
    background-color: #6c757d; /* ç°è‰²æŒ‰é’® */
    color: white;
    border: none;
    padding: 8px 15px; /* è°ƒæ•´å†…è¾¹è· */
    border-radius: 6px; /* è°ƒæ•´åœ†è§’ */
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    font-weight: 500;
    font-size: 0.9em;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.quick-date-filters button:hover {
    background-color: #5a6268; /* æ·±ç°è‰² */
    transform: translateY(-1px); /* è½»å¾®ä¸Šæµ®æ•ˆæœ */
}

.quick-date-filters button:active {
    background-color: #4e545a; /* ç‚¹å‡»æ—¶æ›´æ·±çš„é¢œè‰² */
    transform: translateY(0); /* æ¢å¤ä½ç½® */
    box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* æ›´å°çš„é˜´å½± */
}

.quick-date-filters button.active {
    background-color: #007bff;
    color: white;
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    transform: translateY(-1px);
}

/* å¼€å…³æ ·å¼ */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #007bff;
}

input:focus + .slider {
    box-shadow: 0 0 1px #007bff;
}

input:checked + .slider:before {
    transform: translateX(22px);
}

/* ç§»é™¤æ—§çš„ button æ ·å¼ï¼Œå› ä¸º quick-date-filters æŒ‰é’®æœ‰è‡ªå·±çš„æ ·å¼ */
/* ç»Ÿä¸€ä½¿ç”¨ quick-date-filters button çš„æ ·å¼ï¼Œæˆ–æ ¹æ®éœ€è¦å®šä¹‰é€šç”¨æŒ‰é’®æ ·å¼ */
/* å¦‚æœéœ€è¦å…¶ä»–é€šç”¨æŒ‰é’®ï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ª .btn ç±» */

.filters label {
    font-weight: bold;
}

/* ç§»é™¤ .filters select æ ·å¼ï¼Œå› ä¸ºç›®å‰æ²¡æœ‰ select å…ƒç´  */

/* é”™è¯¯æ¶ˆæ¯æ ·å¼ */
.error-message {
    color: #dc3545; /* çº¢è‰² */
    background-color: #f8d7da; /* æµ…çº¢è‰²èƒŒæ™¯ */
    border: 1px solid #f5c6cb;
    border-radius: 8px;
    padding: 15px 20px;
    margin-top: 20px;
    font-size: 1.1em;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}


.chart-container {
    display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
    gap: 25px; /* å›¾è¡¨ä¹‹é—´çš„é—´è· */
    margin-bottom: 40px;
    padding: 25px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
}

.chart-wrapper {
    flex: 1;
    position: relative; /* ä¸º Chart.js æä¾›å®šä½ä¸Šä¸‹æ–‡ */
    height: 450px; /* ä¸ºå›¾è¡¨è®¾ç½®ä¸€ä¸ªå›ºå®šçš„é«˜åº¦ */
}

canvas {
    max-width: 100%;
    /* ç§»é™¤ height: auto !important; ä»¥é¿å…ä¸ Chart.js å†²çª */
}

.main-content {
    display: flex;
    gap: 30px; /* å¢åŠ é—´è· */
    margin-top: 30px;
    /* ç§»é™¤ main-content è‡ªèº«çš„è¾¹æ¡†ã€å†…è¾¹è·ã€èƒŒæ™¯å’Œé˜´å½±ï¼Œç”±å…¶å­å…ƒç´ æ§åˆ¶ */
    flex-wrap: wrap;
    justify-content: center; /* å±…ä¸­å†…å®¹ */
}

@media (max-width: 1024px) { /* è°ƒæ•´åª’ä½“æŸ¥è¯¢æ–­ç‚¹ */
    .main-content {
        flex-direction: column;
        align-items: center; /* å±…ä¸­åˆ—å¸ƒå±€å†…å®¹ */
    }
    
    .main-content .product-summary-section, /* é’ˆå¯¹äº§å“æ±‡æ€»éƒ¨åˆ† */
    .reviews-container {
        min-width: unset; /* ç§»é™¤æœ€å°å®½åº¦é™åˆ¶ */
        width: 100%; /* å æ®å…¨éƒ¨å®½åº¦ */
        max-width: 700px; /* è®¾ç½®æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢è¿‡å®½ */
    }
    
    .filter-group {
        flex: 1 1 100%;
    }
    
    .date-picker, #productId {
        width: 100%;
    }
}

/* é¡µè„šæ ·å¼ */
.footer {
    text-align: center;
    margin-top: 40px;
    padding: 20px;
    color: #6c757d;
    font-size: 0.9em;
    border-top: 1px solid #e9ecef;
    background-color: #f8f9fa;
    border-radius: 0 0 16px 16px; /* ä¸ container åº•éƒ¨åœ†è§’åŒ¹é… */
}

.main-content table {
    flex: 1; /* è¡¨æ ¼å æ® 1/3 æ¯”ä¾‹ */
    min-width: 450px; /* è°ƒæ•´æœ€å°å®½åº¦ */
    width: 100%; /* ç¡®ä¿åœ¨ flex å®¹å™¨ä¸­æ­£ç¡®æ˜¾ç¤º */
    border-collapse: collapse;
    border-radius: 12px; /* æ›´å¤§çš„åœ†è§’ */
    overflow: hidden; /* ç¡®ä¿åœ†è§’ç”Ÿæ•ˆ */
    background-color: #ffffff;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* æ·»åŠ é˜´å½± */
    border: 1px solid #e0e0e0; /* ç»†è¾¹æ¡† */
}

.main-content table th, .main-content table td {
    border: 1px solid #f0f0f0; /* æ›´æµ…çš„è¾¹æ¡† */
    padding: 15px 20px; /* å¢åŠ å†…è¾¹è· */
    text-align: left;
}

.main-content table th {
    background-color: #007bff; /* è“è‰²èƒŒæ™¯ */
    color: white;
    font-weight: 600; /* æ›´ç²—çš„å­—ä½“ */
    text-transform: uppercase; /* å¤§å†™ */
    font-size: 0.9em;
}

.main-content table tr:nth-child(even) {
    background-color: #f8f9fa; /* æµ…ç°è‰²æ¡çº¹ */
}

.main-content table tr:hover {
    background-color: #e9ecef; /* æ‚¬åœèƒŒæ™¯è‰² */
    cursor: pointer; /* é¼ æ ‡æŒ‡é’ˆ */
}

.main-content table tr.selected {
    background-color: #007bff;
    color: white;
    font-weight: bold;
}

.main-content table tr.selected:hover {
    background-color: #0056b3;
}

.reviews-container {
    flex: 2; /* è¯„è®ºè¯¦æƒ…å æ® 2/3 æ¯”ä¾‹ */
    min-width: 600px; /* è°ƒæ•´æœ€å°å®½åº¦ */
    padding: 30px; /* å¢åŠ å†…è¾¹è· */
    border: 1px solid #e0e0e0; /* ç»†è¾¹æ¡† */
    border-radius: 12px; /* æ›´å¤§çš„åœ†è§’ */
    overflow-y: auto; /* å…è®¸è¯„è®ºè¯¦æƒ…æ»šåŠ¨ */
    max-height: 700px; /* å¢åŠ æœ€å¤§é«˜åº¦ */
    background-color: #ffffff;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* æ·»åŠ é˜´å½± */
}

.review-item {
    border-bottom: 1px solid #e9ecef; /* æ›´æµ…çš„åˆ†å‰²çº¿ */
    padding: 20px 0; /* å¢åŠ å†…è¾¹è· */
}

.review-item:last-child {
    border-bottom: none;
}

.review-author-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.review-author-name {
    font-weight: bold;
    color: #343a40;
}

.top-reviewer-badge {
    background-color: #17a2b8;
    color: white;
    font-size: 0.75em;
    padding: 2px 6px;
    border-radius: 4px;
    margin-left: 8px;
    vertical-align: middle;
    font-weight: bold;
}

.review-date {
    color: #6c757d;
}

.review-product-info {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 12px;
    font-size: 0.9em;
}

.review-product-info p {
    margin: 0;
    line-height: 1.5;
}

.review-rating {
    color: #ffc107;
    font-size: 1.2em;
    margin-bottom: 12px;
}

.review-content {
    margin: 15px 0;
    font-size: 0.95em;
    color: #495057;
    line-height: 1.7;
    white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œç¬¦ */
}

.review-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 15px;
    border-top: 1px solid #e9ecef;
    padding-top: 10px;
}

.review-id {
    font-family: monospace;
}

.helpful-count {
    display: flex;
    align-items: center;
    gap: 5px;
}

.review-attachments {
    margin-top: 15px; /* å¢åŠ ä¸è¯„è®ºå†…å®¹çš„é—´è· */
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* å›¾ç‰‡ä¹‹é—´çš„é—´è· */
}

.review-attachments img {
    max-width: 120px; /* å¢å¤§å›¾ç‰‡å°ºå¯¸ */
    height: auto;
    border-radius: 8px; /* åœ†è§’å›¾ç‰‡ */
    border: 1px solid #e0e0e0; /* å›¾ç‰‡è¾¹æ¡† */
    box-shadow: 0 2px 8px rgba(0,0,0,0.08); /* å›¾ç‰‡é˜´å½± */
    transition: transform 0.2s ease-in-out;
}

.review-attachments img:hover {
    transform: scale(1.05); /* æ‚¬åœæ”¾å¤§æ•ˆæœ */
}

.instruction-tooltip {
    position: fixed;
    bottom: 25px; /* è°ƒæ•´ä½ç½® */
    right: 25px; /* æ”¾ç½®åœ¨å³ä¸‹è§’ */
    left: auto; /* ç§»é™¤å·¦ä¾§å®šä½ */
    background-color: #2c3e50; /* æ·±è‰²èƒŒæ™¯ */
    color: white;
    padding: 20px; /* å¢åŠ å†…è¾¹è· */
    border-radius: 10px; /* è°ƒæ•´åœ†è§’ */
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25); /* æ›´æ˜æ˜¾çš„é˜´å½± */
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px); /* åˆå§‹å‘ä¸‹åç§» */
    transition: opacity 0.4s ease-out, visibility 0.4s ease-out, transform 0.4s ease-out;
    max-width: 350px; /* è°ƒæ•´æœ€å¤§å®½åº¦ */
    border: 1px solid rgba(255, 255, 255, 0.1); /* ç»†è¾¹æ¡† */
}

.instruction-tooltip.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0); /* å‘ä¸Šç§»åŠ¨åˆ°æœ€ç»ˆä½ç½® */
}

.instruction-tooltip h2 {
    color: #007bff; /* è“è‰²æ ‡é¢˜ */
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 1.3em; /* å¢å¤§å­—å· */
    font-weight: 600;
}

.instruction-tooltip p {
    font-size: 0.95em; /* è°ƒæ•´å­—å· */
    line-height: 1.5;
    margin-bottom: 8px;
}

/* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1001;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
}

.loading-overlay.show {
    opacity: 1;
    visibility: visible;
}

.spinner {
    border: 6px solid #f3f3f3; /* Light grey */
    border-top: 6px solid #007bff; /* Blue */
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.reviews-section {
    flex: 2;
    min-width: 600px;
    display: flex;
    flex-direction: column;
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden; /* ç¡®ä¿å­å…ƒç´ ä¸ä¼šæº¢å‡ºåœ†è§’ */
}

.reviews-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 30px;
    border-bottom: 1px solid #e9ecef;
    background-color: #f8f9fa;
}

.reviews-header h2 {
    margin: 0;
    font-size: 1.5em;
    color: #343a40;
}

#review-count-display {
    font-size: 1.1em;
    font-weight: 600;
    color: #007bff;
    background-color: rgba(0, 123, 255, 0.1);
    padding: 5px 12px;
    border-radius: 6px;
}

#filter-status-display {
    font-size: 0.7em;
    font-weight: normal;
    color: #6c757d;
    background-color: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    margin-left: 10px;
}

#filter-status-display button {
    background: none;
    border: none;
    color: #dc3545;
    font-weight: bold;
    cursor: pointer;
    margin-left: 5px;
}

.reviews-container {
    padding: 0 30px 30px 30px; /* è°ƒæ•´å†…è¾¹è· */
    overflow-y: auto;
    max-height: 640px; /* è°ƒæ•´æœ€å¤§é«˜åº¦ */
    flex-grow: 1;
    /* ç§»é™¤ä¹‹å‰çš„æ ·å¼ï¼Œå› ä¸ºå®ƒä»¬è¢«ç§»åˆ°äº† .reviews-section */
    border: none;
    box-shadow: none;
    background-color: transparent;
    min-width: unset;
    flex: unset;
}

</style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script> <!-- Flatpickr ä¸­æ–‡è¯­è¨€åŒ… -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script> <!-- Moment.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script> <!-- Chart.js Moment é€‚é…å™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script> <!-- PapaParse CSV è§£æåº“ -->
</head>
<body>
    <div class="container">
        <h1>Coupang è¯„è®ºåˆ†æç³»ç»Ÿ v1.3</h1>
        
        <div class="file-upload">
            <input type="file" id="csvFileInput" accept=".csv" multiple>
            <button id="csvUploadBtn" class="upload-btn">é€‰æ‹©CSVæ–‡ä»¶</button>
        </div>

        <div id="initial-state">
            <h2>æ¬¢è¿ä½¿ç”¨è¯„è®ºåˆ†æç³»ç»Ÿ</h2>
            <p>è¯·ç‚¹å‡»ä¸Šæ–¹çš„â€œé€‰æ‹©CSVæ–‡ä»¶â€æŒ‰é’®ï¼Œå¼€å§‹æ‚¨çš„è¯„è®ºåˆ†æä¹‹æ—…ã€‚</p>
        </div>

        <div id="main-app-content" class="hidden">
            <div class="filters">
            <div class="filter-group">
                <label for="productId">äº§å“ID:</label>
                <input type="text" id="productId" placeholder="è¾“å…¥äº§å“IDç­›é€‰">
            </div>
            <div class="filter-group">
                <label for="topReviewsOnly">åªæ˜¾ç¤ºTOPè¯„è®º</label>
                <label class="switch">
                    <input type="checkbox" id="topReviewsOnly">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="filter-group date-filter-group">
                <label for="dateRange">æ—¥æœŸèŒƒå›´:</label>
                <input type="text" id="dateRange" class="date-picker" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-wrapper">
                <h3>æ¯æ—¥æ–°å¢è¯„è®ºè¶‹åŠ¿</h3>
                <canvas id="newReviewsTrendChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <h3>æ¯æ—¥è¯„è®ºæ€»æ•°è¶‹åŠ¿ (å¿«ç…§)</h3>
                <canvas id="totalReviewsSnapshotChart"></canvas>
            </div>
        </div>

        <div class="main-content">
            <div class="product-summary-section">
                <h2>äº§å“è¯„è®ºæ±‡æ€»</h2>
                <table>
                    <thead>
                        <tr>
                            <th>äº§å“ID</th>
                            <th>è¯„è®ºæ€»æ•°</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¡¨æ ¼å†…å®¹å°†ç”± JavaScript å¡«å…… -->
                    </tbody>
                </table>
            </div>
            
            <div class="reviews-section">
                <div class="reviews-header">
                    <h2>è¯„è®ºè¯¦æƒ… <span id="filter-status-display"></span></h2>
                    <span id="review-count-display"></span>
                </div>
                <div class="reviews-container">
                    <!-- è¯„è®ºå†…å®¹å°†ç”± JavaScript å¡«å…… -->
                </div>
            </div>
        </div>
    </div>
</div>

    <div id="instruction-tooltip" class="instruction-tooltip">
        <h2>ä½¿ç”¨è¯´æ˜</h2>
        <p>1. é€‰æ‹©æ—¥æœŸèŒƒå›´æˆ–ç‚¹å‡»å¿«é€Ÿç­›é€‰æŒ‰é’®ï¼ŒæŸ¥çœ‹è¯„è®ºè¶‹åŠ¿å’Œè¯¦æƒ…ã€‚</p>
        <p>2. è¾“å…¥äº§å“IDå¯ç­›é€‰ç‰¹å®šäº§å“è¯„è®ºã€‚</p>
        <p>3. è¯„è®ºæŒ‰æ—¥æœŸå€’åºæ’åˆ—ï¼Œæœ€æ–°è¯„è®ºåœ¨å‰ã€‚</p>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text"></p>
    </div>

    <script>
// å…¨å±€æ•°æ®å’Œå›¾è¡¨å®ä¾‹
let allData = []; // å­˜å‚¨åŸºäº createdAt èšåˆçš„æ•°æ®
let snapshotData = []; // å­˜å‚¨åŸºäºæ–‡ä»¶æ—¥æœŸçš„å¿«ç…§æ•°æ®
let newReviewsTrendChart = null; // æ–°å¢è¯„è®ºè¶‹åŠ¿å›¾è¡¨
let totalReviewsSnapshotChart = null; // æ€»æ•°å¿«ç…§è¶‹åŠ¿å›¾è¡¨
let flatpickrInstance = null;

// è·å– DOM å…ƒç´ 
const loadingOverlay = document.getElementById('loading-overlay');
const loadingText = document.getElementById('loading-text');
const mainContent = document.querySelector('.main-content');
const productIdInput = document.getElementById('productId');
const topReviewsOnlyCheckbox = document.getElementById('topReviewsOnly');
const dateRangeInput = document.getElementById('dateRange');
const productSummaryTableBody = document.querySelector('.product-summary-section table tbody');
const reviewsContainer = document.querySelector('.reviews-container');
const instructionTooltip = document.getElementById('instruction-tooltip');
const reviewCountDisplay = document.getElementById('review-count-display');
const filterStatusDisplay = document.getElementById('filter-status-display');
const csvFileInput = document.getElementById('csvFileInput');
const initialStateDiv = document.getElementById('initial-state');
const mainAppContentDiv = document.getElementById('main-app-content');

// æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
function showLoading(message = '') {
    if (loadingText) loadingText.textContent = message;
    if (loadingOverlay) loadingOverlay.classList.add('show');
}

// éšè—åŠ è½½æŒ‡ç¤ºå™¨
function hideLoading() {
    if (loadingText) loadingText.textContent = '';
    if (loadingOverlay) loadingOverlay.classList.remove('show');
}

// CSV è§£æå‡½æ•°
async function parseCSV(file) {
    return new Promise((resolve, reject) => {
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.errors.length) {
                    console.error('PapaParse errors:', results.errors);
                    reject(new Error('CSV parsing errors occurred.'));
                }
                resolve(results.data);
            },
            error: (error) => reject(error)
        });
    });
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
async function handleFileSelect(event) {
    showLoading('å¼€å§‹å¤„ç†æ–‡ä»¶...');
    try {
        const files = event.target.files;
        let allRawReviews = [];
        const processedReviewIds = new Set();
        snapshotData = []; // æ¸…ç©ºæ—§å¿«ç…§æ•°æ®

        const datedFiles = Array.from(files)
            .map(file => {
                const match = file.name.match(/(\d{8})/);
                return { file, date: match ? moment(match[1], 'YYYYMMDD') : null };
            })
            .filter(f => f.date && f.date.isValid())
            .sort((a, b) => a.date.diff(b.date));

        for (const [index, { file, date }] of datedFiles.entries()) {
            showLoading(`æ­£åœ¨å¤„ç†æ–‡ä»¶ ${index + 1} / ${datedFiles.length}: ${file.name}`);
            const parsedData = await parseCSV(file);
            
            // 1. è®¡ç®—å¿«ç…§æ•°æ®
            let totalReviews = parsedData.length;
            let topReviews = parsedData.filter(row => row.reviewerRank && row.reviewerRank.trim() !== '').length;
            snapshotData.push({
                date: date.format('YYYY-MM-DD'),
                totalReviews,
                topReviews
            });

            // 2. æ”¶é›†æ‰€æœ‰åŸå§‹è¯„è®ºç”¨äºæ–°å¢è¶‹åŠ¿è®¡ç®—
            parsedData.forEach(row => {
                if (row.reviewId && !processedReviewIds.has(row.reviewId)) {
                    allRawReviews.push(row);
                    processedReviewIds.add(row.reviewId);
                }
            });
        }

        // 3. èšåˆè®¡ç®—æ¯æ—¥æ–°å¢è¯„è®º
        const aggregatedMap = new Map();
        allRawReviews.forEach(row => {
            const createdAtDate = row.createdAt ? row.createdAt.split(' ')[0] : '1970-01-01';
            if (!moment(createdAtDate, 'YYYY-MM-DD').isValid()) return;

            const productId = row.productId || 'N/A';
            const key = `${createdAtDate}-${productId}`;

            if (!aggregatedMap.has(key)) {
                aggregatedMap.set(key, {
                    date: createdAtDate,
                    productId: productId,
                    totalReviews: 0,
                    topReviews: 0,
                    itemName: row.itemName || 'æœªçŸ¥å•†å“',
                    reviews: []
                });
            }

            const entry = aggregatedMap.get(key);
            entry.totalReviews += 1;
            if (row.reviewerRank && row.reviewerRank.trim() !== '') {
                entry.topReviews += 1;
            }
            entry.reviews.push({
                reviewId: row.reviewId,
                rating: parseInt(row.rating) || 0,
                content: row.content || '',
                helpfulTrueCount: parseInt(row.helpfulTrueCount) || 0,
                attachments: row.attachments || '[]',
                createdAt: row.createdAt,
                displayName: row.displayName || 'ìµëª…',
                vendorName: row.vendorName || 'ì •ë³´ ì—†ìŒ',
                reviewerRank: row.reviewerRank || ''
            });
        });

        allData = Array.from(aggregatedMap.values());

        if (allData.length === 0 && snapshotData.length === 0) {
            console.warn('No data was processed from CSV files');
            return;
        }

        // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨èŒƒå›´
        updateFlatpickrRange();
        
        renderPage();

        // æ˜¾ç¤ºä¸»åº”ç”¨å†…å®¹ï¼Œéšè—åˆå§‹çŠ¶æ€
        if (initialStateDiv) initialStateDiv.classList.add('hidden');
        if (mainAppContentDiv) mainAppContentDiv.classList.remove('hidden');

    } catch (error) {
        console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:', error);
        if (mainContent) {
            mainContent.innerHTML = `<p class="error-message">æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š${error.message}ã€‚</p>`;
        }
    } finally {
        hideLoading();
    }
}

function updateFlatpickrRange() {
    const allDates = [
        ...allData.map(item => new Date(item.date)),
        ...snapshotData.map(item => new Date(item.date))
    ].filter(date => !isNaN(date.getTime()));

    if (allDates.length > 0) {
        const minDate = new Date(Math.min(...allDates));
        const maxDate = new Date(Math.max(...allDates));
        if (flatpickrInstance) {
            flatpickrInstance.set('minDate', minDate);
            flatpickrInstance.set('maxDate', maxDate);
            flatpickrInstance.setDate([minDate, maxDate], true);
        }
    }
}

// DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('csvUploadBtn').addEventListener('click', () => {
        csvFileInput.click();
    });
    csvFileInput.addEventListener('change', handleFileSelect);

    flatpickrInstance = flatpickr(dateRangeInput, {
        mode: "range",
        dateFormat: "Y-m-d",
        locale: "zh",
        onChange: () => renderPage() // æ¢å¤ç®€å•ã€ç»Ÿä¸€çš„ onChange è§¦å‘
    });

    initializeNewReviewsChart();
    initializeSnapshotChart();

    productIdInput.addEventListener('input', debounce(renderPage, 300));
    topReviewsOnlyCheckbox.addEventListener('change', renderPage);
});

// åˆå§‹åŒ–å›¾è¡¨
function initializeChart(canvasId, onClickHandler) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { 
                type: 'time', 
                time: { 
                    unit: 'day',
                    tooltipFormat: 'YYYY-MM-DD',
                    displayFormats: {
                        day: 'MMM D',
                        week: 'MMM D',
                        month: 'YYYY MMM'
                    }
                },
                ticks: {
                    autoSkip: true,
                    maxTicksLimit: 15 
                }
            },
            y: { 
                beginAtZero: true,
                ticks: {
                    stepSize: 1, // ç¡®ä¿Yè½´åˆ»åº¦ä¸ºæ•´æ•°
                    callback: function(value) {
                        if (Math.floor(value) === value) {
                            return value;
                        }
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                mode: 'index',
                intersect: false,
            }
        }
    };

    if (onClickHandler) {
        chartOptions.onClick = onClickHandler;
    }

    return new Chart(ctx, {
        type: 'line',
        data: { 
            labels: [], 
            datasets: [
                { label: 'æ¯æ—¥æ€»è¯„è®ºæ•°', data: [], borderColor: '#007bff', fill: false, tension: 0.1 },
                { label: 'æ¯æ—¥TOPè¯„è®ºæ•°', data: [], borderColor: '#28a745', fill: false, tension: 0.1 }
            ]
        },
        options: chartOptions
    });
}

function initializeNewReviewsChart() {
    newReviewsTrendChart = initializeChart('newReviewsTrendChart', (event) => {
        const points = newReviewsTrendChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
        if (points.length) {
            const firstPoint = points[0];
            const label = newReviewsTrendChart.data.labels[firstPoint.index];
            const clickedDate = moment(label);
            
            // ç­›é€‰å¹¶åªæ˜¾ç¤ºé‚£ä¸€å¤©çš„è¯„è®º
            filterAndDisplayReviewsForDate(clickedDate);
        }
    });
}

function initializeSnapshotChart() {
    totalReviewsSnapshotChart = initializeChart('totalReviewsSnapshotChart');
}

// ä¸»æ¸²æŸ“å‡½æ•°
function renderPage() {
    console.log(`[è°ƒè¯•] å¼€å§‹æ¸²æŸ“é¡µé¢ (renderPage)...`);
    showLoading();
    try {
        const productIdFilter = productIdInput.value.trim();
        const selectedDates = flatpickrInstance.selectedDates;
        if (selectedDates.length < 2) {
             hideLoading();
             return;
        }
        const startDate = moment(selectedDates[0]).startOf('day');
        const endDate = moment(selectedDates[1]).endOf('day');
        console.log(`[è°ƒè¯•] renderPage ä½¿ç”¨çš„æ—¥æœŸèŒƒå›´: ${startDate.format('YYYY-MM-DD')} è‡³ ${endDate.format('YYYY-MM-DD')}`);

        // ç­›é€‰æ–°å¢è¯„è®ºæ•°æ®
        const filteredNewReviewsData = allData.filter(item => {
            const itemDate = moment(item.date);
            const dateMatch = itemDate.isBetween(startDate, endDate, 'day', '[]');
            const productMatch = !productIdFilter || item.productId.includes(productIdFilter);
            return dateMatch && productMatch;
        });
        console.log(`[è°ƒè¯•] ç­›é€‰å "æ–°å¢è¯„è®º" æ•°æ®æ¡æ•°: ${filteredNewReviewsData.length}`);

        // ç­›é€‰å¿«ç…§æ•°æ®
        const filteredSnapshotData = snapshotData.filter(item => {
            const itemDate = moment(item.date);
            return itemDate.isBetween(startDate, endDate, 'day', '[]');
        });
        console.log(`[è°ƒè¯•] ç­›é€‰å "å¿«ç…§" æ•°æ®æ¡æ•°: ${filteredSnapshotData.length}`);

        updateNewReviewsChart(filteredNewReviewsData, startDate, endDate);
        updateSnapshotChart(filteredSnapshotData, startDate, endDate);
        
        const allFilteredReviews = filteredNewReviewsData.flatMap(item => item.reviews.map(review => ({...review, productId: item.productId, itemName: item.itemName})));
        const topReviewsOnly = topReviewsOnlyCheckbox.checked;
        const reviewsToRender = topReviewsOnly
            ? allFilteredReviews.filter(r => r.reviewerRank && r.reviewerRank.trim() !== '')
            : allFilteredReviews;
        
        updateProductSummaryTable(filteredNewReviewsData);
        updateDetailedReviews(reviewsToRender);

        // æ¸…é™¤ç‰¹å®šæ—¥æœŸç­›é€‰çŠ¶æ€
        filterStatusDisplay.innerHTML = '';

    } catch (error) {
        console.error('Error in renderPage:', error);
    } finally {
        hideLoading();
    }
}

// æ ¹æ®æ—¥æœŸèŒƒå›´è·å–æœ€ä½³çš„å›¾è¡¨æ—¶é—´å•ä½
function getChartTimeUnit(startDate, endDate) {
    const diffDays = endDate.diff(startDate, 'days');
    if (diffDays > 90) return 'month';
    if (diffDays > 30) return 'week';
    return 'day';
}

// æ›´æ–°å›¾è¡¨
function updateChart(chart, data, dateRange, totalKey, topKey) {
    // åŠ¨æ€è°ƒæ•´æ—¶é—´å•ä½
    const timeUnit = getChartTimeUnit(dateRange.startDate, dateRange.endDate);
    chart.options.scales.x.time.unit = timeUnit;

    const dailyCounts = {};
    for (let m = dateRange.startDate.clone(); m.isSameOrBefore(dateRange.endDate, 'day'); m.add(1, 'days')) {
        const dateKey = m.format('YYYY-MM-DD');
        dailyCounts[dateKey] = { total: 0, top: 0 };
    }

    data.forEach(item => {
        const dateKey = moment(item.date).format('YYYY-MM-DD');
        if (dailyCounts[dateKey]) {
            dailyCounts[dateKey].total += item[totalKey];
            dailyCounts[dateKey].top += item[topKey];
        }
    });

    const sortedDates = Object.keys(dailyCounts).sort();
    const totalData = sortedDates.map(date => dailyCounts[date].total);
    const topData = sortedDates.map(date => dailyCounts[date].top);

    console.log(`[è°ƒè¯•] æ›´æ–°å›¾è¡¨ ${chart.canvas.id}:`, {
        labels: sortedDates,
        totalData: totalData,
        topData: topData
    });

    chart.data.labels = sortedDates;
    chart.data.datasets[0].data = totalData;
    chart.data.datasets[1].data = topData;
    chart.update();
}

function updateNewReviewsChart(items, startDate, endDate) {
    updateChart(newReviewsTrendChart, items, {startDate, endDate}, 'totalReviews', 'topReviews');
}

function updateSnapshotChart(items, startDate, endDate) {
    updateChart(totalReviewsSnapshotChart, items, {startDate, endDate}, 'totalReviews', 'topReviews');
}

// æ›´æ–°äº§å“æ±‡æ€»
function updateProductSummaryTable(items) {
    if (!productSummaryTableBody) return;
    const productCounts = items.reduce((acc, item) => {
        acc[item.productId] = (acc[item.productId] || 0) + item.reviews.length;
        return acc;
    }, {});
    const sortedProducts = Object.entries(productCounts).sort(([, a], [, b]) => b - a);
    
    productSummaryTableBody.innerHTML = sortedProducts.length 
        ? sortedProducts.map(([id, count]) => `<tr data-product-id="${id}"><td>${id}</td><td>${count}</td></tr>`).join('') 
        : '<tr><td colspan="2">æ— æ•°æ®</td></tr>';

    // ä¸ºæ¯ä¸€è¡Œæ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
    productSummaryTableBody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => {
            const productId = row.dataset.productId;
            if (!productId) return;

            // ç§»é™¤å…¶ä»–è¡Œçš„é€‰ä¸­çŠ¶æ€
            productSummaryTableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
            
            // å¦‚æœå½“å‰ç­›é€‰çš„å°±æ˜¯è¿™ä¸ªäº§å“IDï¼Œåˆ™å–æ¶ˆç­›é€‰
            if (productIdInput.value === productId) {
                productIdInput.value = '';
            } else {
                productIdInput.value = productId;
                row.classList.add('selected');
            }
            
            renderPage();
        });
    });
}

// æ›´æ–°è¯¦ç»†è¯„è®º
function filterAndDisplayReviewsForDate(targetDate) {
    showLoading();
    try {
        const productIdFilter = productIdInput.value.trim();
        const topReviewsOnly = topReviewsOnlyCheckbox.checked;

        const reviewsForDate = allData
            .filter(item => {
                const itemDate = moment(item.date);
                const productMatch = !productIdFilter || item.productId.includes(productIdFilter);
                return itemDate.isSame(targetDate, 'day') && productMatch;
            })
            .flatMap(item => item.reviews.map(review => ({...review, productId: item.productId, itemName: item.itemName})));

        const reviewsToRender = topReviewsOnly
            ? reviewsForDate.filter(r => r.reviewerRank && r.reviewerRank.trim() !== '')
            : reviewsForDate;

        updateDetailedReviews(reviewsToRender);

        // æ˜¾ç¤ºç­›é€‰çŠ¶æ€
        filterStatusDisplay.innerHTML = `[æ­£åœ¨æ˜¾ç¤º ${targetDate.format('YYYY-MM-DD')} çš„è¯„è®º <button id="clear-date-filter">x</button>]`;
        document.getElementById('clear-date-filter').addEventListener('click', () => {
            renderPage();
        });

    } catch (error) {
        console.error('Error in filterAndDisplayReviewsForDate:', error);
    } finally {
        hideLoading();
    }
}

// æ›´æ–°è¯¦ç»†è¯„è®º
function updateDetailedReviews(reviews) {
    if (!reviewsContainer || !reviewCountDisplay) return;
    const topReviewsCount = reviews.filter(r => r.reviewerRank && r.reviewerRank.trim() !== '').length;
    reviewCountDisplay.textContent = `${reviews.length} æ¡è¯„è®º (${topReviewsCount} æ¡TOPè¯„è®º)`;
    reviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    const fragment = document.createDocumentFragment();
    if (reviews.length === 0) {
        reviewsContainer.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è¯„è®ºã€‚</p>';
    } else {
        reviews.forEach(review => {
            const reviewItem = document.createElement('div');
            reviewItem.className = 'review-item';
            const topBadge = review.reviewerRank ? `<span class="top-reviewer-badge">${review.reviewerRank}</span>` : '';
            const attachments = (JSON.parse(review.attachments || '[]').map(att => `<img src="${att.imgSrcOrigin}" loading="lazy">`).join(''));
            reviewItem.innerHTML = `
                <div class="review-author-info">
                    <span class="review-author-name">${review.displayName || 'ìµëª…'} ${topBadge}</span>
                    <span class="review-date">${moment(review.createdAt).format('YYYY.MM.DD')}</span>
                </div>
                <div class="review-product-info"><p>${review.itemName}</p><p><strong>íŒë§¤ì:</strong> ${review.vendorName || 'ì •ë³´ ì—†ìŒ'}</p></div>
                <div class="review-rating">${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - (review.rating || 0))}</div>
                ${attachments ? `<div class="review-attachments">${attachments}</div>` : ''}
                <p class="review-content">${review.content || 'æ— '}</p>
                <div class="review-footer"><span class="review-id">ID: ${review.reviewId}</span><span class="helpful-count">ğŸ‘ ${review.helpfulTrueCount || 0}</span></div>
            `;
            fragment.appendChild(reviewItem);
        });
        reviewsContainer.innerHTML = '';
        reviewsContainer.appendChild(fragment);
    }
}

// é˜²æŠ–å‡½æ•°
function debounce(func, timeout = 300) {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
}

</script>
</body>
</html>
